<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tienda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <script defer>
        const API_URL = "/dsaApp";
        let loggedInUser = null;

        $(document).ready(function(){
            loggedInUser = localStorage.getItem("loggedInUser");

            if (!loggedInUser) {
                window.location.href = "login.html";
                return;
            }

            $("#user-display").text(loggedInUser);
            loadInventory(loggedInUser);

            // LOGOUT CON TOAST
            $("#logout-btn").click(function(){
                localStorage.removeItem("loggedInUser");
                mostrarNotificacion("Cerrando sesión...", "exito");

                setTimeout(() => {
                    window.location.href = "login.html";
                }, 1500);
            });

            $(".buy-btn").click(function(e){
                e.preventDefault();
                const objectId = $(this).data("id");

                const requestBody = {
                    "nombre": loggedInUser,
                    "objectId": objectId
                };

                fetch(API_URL + "/game/users/objects/add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error("No tienes dinero suficiente o el objeto no existe");
                        }
                    })
                    .then(updatedUser => {
                        mostrarNotificacion(`¡${objectId} comprado con éxito!`, "exito");
                        loadInventory(loggedInUser);
                    })
                    .catch(error => {
                        mostrarNotificacion("Error: " + error.message, "error");
                    });
            });
        });

        function loadInventory(username) {
            const listElement = $("#inventory-list");
            listElement.html('<li class="list-group-item list-group-item-dark text-center">Actualizando...</li>');

            fetch(API_URL + "/game/users/objects/list?nombre=" + username, {
                method: "GET"
            })
                .then(response => {
                    if (response.ok) return response.json();
                    else throw new Error("No se pudo cargar el inventario.");
                })
                .then(items => {
                    listElement.empty();

                    if (items.length === 0) {
                        listElement.append('<li class="list-group-item list-group-item-dark text-muted">Inventario vacío</li>');
                    } else {
                        items.forEach(item => {
                            listElement.append(`
                            <li class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-box me-2"></i> ${item.nombre}</span>
                            </li>
                        `);
                        });
                    }
                })
                .catch(error => {
                    listElement.empty().append('<li class="list-group-item list-group-item-danger">Error al cargar inventario.</li>');
                    mostrarNotificacion("Error de red al cargar inventario", "error");
                });
        }

        function mostrarNotificacion(mensaje, tipo) {
            const toastElement = document.getElementById('miToast');
            const toastBody = document.getElementById('toastBody');

            toastBody.textContent = mensaje;

            toastElement.classList.remove('text-bg-danger', 'text-bg-success');

            if (tipo === "exito") {
                toastElement.classList.add('text-bg-success');
            } else {
                toastElement.classList.add('text-bg-danger');
            }

            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
    </script>
</head>
<body>

<div id="template-bg-1">
    <div class="d-flex flex-column min-vh-100 justify-content-center align-items-center bg-secondary">
        <div class="card p-4 text-light bg-dark mb-5 shadow-lg" style="width: 100%; max-width: 600px;">

            <div class="card-header d-flex justify-content-between align-items-center border-bottom border-secondary pb-3">
                <h3 class="m-0"><i class="fas fa-store me-2"></i>Tienda</h3>
                <div>
                    <span class="me-3 text-info"><i class="fas fa-user me-1"></i> <span id="user-display">...</span></span>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>

            <div class="card-body w-100 pt-4">

                <h5 class="text-uppercase text-muted mb-3 small">Objetos Disponibles</h5>
                <ul class="list-group mb-4">
                    <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary">
                        <div>
                            <strong><i class="fas fa-khanda me-2"></i>Espada</strong>
                            <small class="d-block text-muted">Corta dragones</small>
                        </div>
                        <button class="btn btn-success btn-sm buy-btn shadow-sm" data-id="Espada">
                            <i class="fas fa-cart-plus"></i> Añadir
                        </button>
                    </li>

                    <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary">
                        <div>
                            <strong><i class="fas fa-shield-alt me-2"></i>Escudo</strong>
                            <small class="d-block text-muted">Resistente al fuego</small>
                        </div>
                        <button class="btn btn-success btn-sm buy-btn shadow-sm" data-id="Escudo">
                            <i class="fas fa-cart-plus"></i> Añadir
                        </button>
                    </li>

                    <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary">
                        <div>
                            <strong><i class="fas fa-flask me-2"></i>Pocion</strong>
                            <small class="d-block text-muted">Recupera energía</small>
                        </div>
                        <button class="btn btn-success btn-sm buy-btn shadow-sm" data-id="Pocion">
                            <i class="fas fa-cart-plus"></i> Añadir
                        </button>
                    </li>
                </ul>

                <hr class="text-secondary">

                <h5 class="text-uppercase text-muted mb-3 small mt-4">Mi Inventario</h5>
                <ul class="list-group" id="inventory-list">
                </ul>

            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="miToast" class="toast border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fw-bold" id="toastBody">
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

</body>
</html>