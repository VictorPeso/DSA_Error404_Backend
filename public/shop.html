<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tienda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script>
        const API_URL = "http://localhost:8080/dsaApp";

        let loggedInUser = null;

        $(document).ready(function(){

            loggedInUser = localStorage.getItem("loggedInUser");

            if (!loggedInUser) {
                alert("¡Necesitas iniciar sesión para acceder a la tienda!");
                window.location.href = "login.html";
                return;
            }

            $("#user-display").text(loggedInUser);
            loadInventory(loggedInUser);

            $("#logout-btn").click(function(){
                localStorage.removeItem("loggedInUser");
                alert("Has cerrado sesión.");
                window.location.href = "login.html";
            });

            $(".buy-btn").click(function(e){
                e.preventDefault();

                const objectId = $(this).data("id");

                const requestBody = {
                    "nombre": loggedInUser,
                    "objectId": objectId
                };

                fetch(API_URL + "/game/users/objects/add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error("No se pudo añadir el objeto (¿Usuario u objeto no existen?)");
                        }
                    })
                    .then(updatedUser => {
                        alert(`¡Objeto "${objectId}" añadido a tu inventario!`);
                        loadInventory(loggedInUser);
                    })
                    .catch(error => {
                        alert("Error: " + error.message);
                    });
            });

        });

        function loadInventory(username) {

            const listElement = $("#inventory-list");
            listElement.empty().append("<li>Cargando...</li>");

            fetch(API_URL + "/game/users/objects/list?nombre=" + username, {
                method: "GET"
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("No se pudo cargar el inventario.");
                    }
                })
                .then(items => {
                    listElement.empty();

                    if (items.length === 0) {
                        listElement.append('<li class="list-group-item list-group-item-dark">Inventario vacío</li>');
                    } else {
                        items.forEach(item => {
                            listElement.append('<li class="list-group-item list-group-item-dark">' + item.nombre + '</li>');
                        });
                    }
                })
                .catch(error => {
                    listElement.empty().append('<li>Error al cargar.</li>');
                    alert("Error: " + error.message);
                });
        }
    </script>
</head>
<body>

<div id="template-bg-1">
    <div class="d-flex flex-column min-vh-100 justify-content-center align-items-center bg-secondary">
        <div class="card p-4 text-light bg-dark mb-5" style="width: 600px;"> <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Tienda (Usuario: <span id="user-display">...</span>)</h3>
            <button type="button" class="btn btn-danger" id="logout-btn">Salir</button>
        </div>

            <div class="card-body w-100">

                <h4>Objetos de la Tienda</h4>
                <ul class="list-group">

                    <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary">
                        <div>
                            <strong>Espada</strong>
                            <small class="d-block text-muted">Corta dragones</small>
                        </div>
                        <button class="btn btn-success buy-btn" data-id="Espada">Añadir</button>
                    </li>

                    <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary">
                        <div>
                            <strong>Escudo</strong>
                            <small class="d-block text-muted">Resistente al fuego</small>
                        </div>
                        <button class="btn btn-success buy-btn" data-id="Escudo">Añadir</button>
                    </li>

                    <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-secondary">
                        <div>
                            <strong>Pocion</strong>
                            <small class="d-block text-muted">Recupera energía</small>
                        </div>
                        <button class="btn btn-success buy-btn" data-id="Pocion">Añadir</button>
                    </li>

                </ul>

                <hr class="text-white">

                <h4>Mi Inventario</h4>
                <ul class="list-group" id="inventory-list">
                </ul>

            </div>
        </div>
    </div>
</div>

</body>
</html>